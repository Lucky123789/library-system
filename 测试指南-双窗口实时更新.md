# 双窗口实时更新测试指南

## 🎯 测试目标

验证：窗口 A 借书/还书后，窗口 B **不刷新**，图书列表和"我的借阅"**自动更新**。

## 📋 准备工作

### 1. 启动服务

**终端 1 - 启动后端：**
```bash
cd server
npm start
```
应该看到：
```
🚀 服务器运行在 http://localhost:4000
📡 WebSocket 服务器已启动
```

**终端 2 - 启动前端：**
```bash
cd client
npm run dev
```
应该看到：
```
VITE v5.x.x  ready in xxx ms
➜  Local:   http://localhost:5173/
```

### 2. 确保 MongoDB 运行

```bash
# 检查 MongoDB
mongosh
# 或启动 MongoDB
brew services start mongodb-community  # macOS
```

## 🧪 测试步骤

### 步骤 1：打开两个浏览器窗口

1. **窗口 A（正常窗口）**
   - 打开浏览器，访问 `http://localhost:5173`
   - 按 `F12` 打开开发者工具，切换到 **Console** 标签
   - 应该看到：`✅ WS connected`

2. **窗口 B（无痕窗口）**
   - 打开无痕/隐私模式窗口，访问 `http://localhost:5173`
   - 按 `F12` 打开开发者工具，切换到 **Console** 标签
   - 应该看到：`✅ WS connected`

### 步骤 2：登录账号

**窗口 A：**
- 注册新账号或登录已有账号（例如：`userA` / `password123`）
- 登录成功后，应该看到导航栏

**窗口 B：**
- 注册新账号或登录已有账号（例如：`userB` / `password123`）
- 登录成功后，应该看到导航栏

> **注意**：可以使用相同账号或不同账号，都能测试实时更新功能。

### 步骤 3：都打开"图书列表"

**窗口 A：**
- 点击导航栏的"图书列表"或直接访问 `http://localhost:5173/books`
- Console 应该看到：`✅ 已添加 WebSocket 消息监听器（图书列表）`
- 确保页面显示了图书列表

**窗口 B：**
- 点击导航栏的"图书列表"或直接访问 `http://localhost:5173/books`
- Console 应该看到：`✅ 已添加 WebSocket 消息监听器（图书列表）`
- 确保页面显示了图书列表

### 步骤 4：测试借书功能

**在窗口 A 中：**
1. 找到一本有库存的图书（可借册数 > 0）
2. 点击"借阅"按钮
3. 等待借阅成功提示

**观察窗口 B：**
- ✅ **不需要手动刷新页面**
- ✅ 图书列表应该**自动刷新**
- ✅ 该图书的"可借册数"应该**自动减少 1**
- ✅ Console 应该看到：
  ```
  📨 收到 WebSocket 原始消息: {"type":"booksUpdated"}
  📦 解析后的消息: {type: "booksUpdated"}
  ✅ 已分发 ws-message 事件
  📡 收到 WebSocket 消息: {type: "booksUpdated"}
  🔄 检测到图书更新，刷新列表...
  ```

**后端控制台应该看到：**
```
✅ 新的 WebSocket 连接
```

### 步骤 5：测试还书功能

**在窗口 A 中：**
1. 点击导航栏的"我的借阅"
2. Console 应该看到：`✅ 已添加 WebSocket 消息监听器（我的借阅）`
3. 找到一本"借阅中"的图书
4. 点击"归还"按钮
5. 等待归还成功提示

**观察窗口 B：**
- 如果窗口 B 在"图书列表"页面：
  - ✅ 该图书的"可借册数"应该**自动增加 1**
  - ✅ Console 应该看到 WebSocket 消息和刷新日志

- 如果窗口 B 在"我的借阅"页面：
  - ✅ 借阅记录应该**自动更新**
  - ✅ 该图书的状态应该变为"已归还"
  - ✅ Console 应该看到：
    ```
    📡 收到 WebSocket 消息: {type: "booksUpdated"}
    🔄 检测到图书更新，刷新借阅记录...
    ```

## ✅ 预期结果总结

| 操作 | 窗口 A | 窗口 B |
|------|--------|--------|
| A 借书 | 借阅成功，列表刷新 | **自动刷新**，可借册数减少 |
| A 还书 | 归还成功，记录更新 | **自动刷新**，可借册数增加（如果在图书列表）或记录更新（如果在我的借阅） |

## 🔍 调试技巧

### 1. 检查 WebSocket 连接状态

在浏览器 Console 中执行：
```javascript
// 检查 WebSocket 实例
window.__ws

// 检查连接状态（1 = OPEN, 0 = CONNECTING, 2 = CLOSING, 3 = CLOSED）
window.__ws?.readyState

// 应该返回 1（OPEN）
```

### 2. 手动触发测试

在浏览器 Console 中执行：
```javascript
// 手动触发 booksUpdated 事件
window.dispatchEvent(new CustomEvent('ws-message', {
  detail: { type: 'booksUpdated' }
}));
```

应该看到列表自动刷新。

### 3. 查看所有事件监听器

在浏览器 Console 中执行：
```javascript
// 查看当前页面的所有事件监听器（需要 Chrome DevTools）
getEventListeners(window)
```

### 4. 检查后端广播

后端控制台应该看到：
```
✅ 新的 WebSocket 连接  // 每个窗口连接时
```

## ❌ 常见问题排查

### 问题 1：窗口 B 没有自动更新

**可能原因：**
- WebSocket 未连接
- 事件监听器未添加
- 后端未广播消息

**解决方法：**
1. 检查窗口 B 的 Console，应该看到 `✅ WS connected`
2. 检查窗口 B 的 Console，应该看到 `✅ 已添加 WebSocket 消息监听器`
3. 检查后端控制台，应该看到 `✅ 新的 WebSocket 连接`
4. 检查后端控制台，借书/还书时应该看到日志

### 问题 2：WebSocket 连接失败

**可能原因：**
- 后端未启动
- 端口被占用
- 防火墙阻止

**解决方法：**
1. 确认后端运行在 `http://localhost:4000`
2. 访问 `http://localhost:4000/health` 应该返回 `{"status":"ok"}`
3. 检查后端控制台是否有错误

### 问题 3：收到消息但列表不刷新

**可能原因：**
- `fetchBooks` 函数执行失败
- API 请求失败
- 网络问题

**解决方法：**
1. 检查 Console 是否有错误信息
2. 检查 Network 标签，查看 API 请求是否成功
3. 检查后端 API 是否正常

## 📊 成功标志

✅ **两个窗口都显示 `✅ WS connected`**  
✅ **两个窗口都显示 `✅ 已添加 WebSocket 消息监听器`**  
✅ **A 借书/还书后，B 的 Console 显示 WebSocket 消息日志**  
✅ **B 的页面自动刷新，数据更新**  
✅ **后端控制台显示 WebSocket 连接日志**

## 🎉 测试通过标准

- [ ] 窗口 A 和窗口 B 都能成功连接 WebSocket
- [ ] 窗口 A 借书后，窗口 B 的图书列表自动更新（可借册数减少）
- [ ] 窗口 A 还书后，窗口 B 的图书列表自动更新（可借册数增加）
- [ ] 窗口 A 还书后，如果窗口 B 在"我的借阅"页面，记录自动更新
- [ ] 所有操作都**不需要手动刷新页面**

---

**如果所有测试都通过，说明实时更新功能正常工作！** 🎊

